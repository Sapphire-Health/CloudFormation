Parameters:
  LoadBalancerVPCId:
    Description: VPC containing the Load Balancer
    Type: AWS::EC2::VPC::Id

  HSWCertificateARN:
    Description: The Amazon Resource Name (ARN) of the certificate to use with Hyperspace Web
    Type: String

  ICFGCertificateARN:
    Description: The Amazon Resource Name (ARN) of the certificate to use with Haiku/Canto
    Type: String    

Resources:
#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-targetgroup.html
  HSWTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-HSWTargetGroup"
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 3
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200
      Port: 443
      Protocol: HTTPS
      ProtocolVersion: HTTP1
      TargetType: ip
      Targets: 
        - Id: !ImportValue EpicRO-HSW1IPAddress
          AvailabilityZone: all        
        - Id: !ImportValue EpicRO-HSW2IPAddress
          AvailabilityZone: all        
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 3600
        - Key: stickiness.enabled
          Value: true
        - Key: stickiness.type
          Value: app_cookie
        - Key: stickiness.app_cookie.cookie_name
          Value: AWSHSWCOOKIE
        - Key: stickiness.app_cookie.duration_seconds
          Value: 86400
      VpcId: !Ref LoadBalancerVPCId                 

  ICFGTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-ICTargetGroup"
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 3
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200
      Port: 443
      Protocol: HTTPS
      ProtocolVersion: HTTP1
      TargetType: ip
      Targets: 
        - Id: !ImportValue EpicRO-IC1IPAddress
          AvailabilityZone: all
        - Id: !ImportValue EpicRO-IC2IPAddress
          AvailabilityZone: all        
      VpcId: !Ref LoadBalancerVPCId    

#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-loadbalancer.html
  HSWALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties: 
      IpAddressType: ipv4
      Name: !Sub "${AWS::StackName}-HSWALB"
      Scheme: internet-facing
      Subnets: 
        - !ImportValue EpicRO-CentralIngressPublic1
        - !ImportValue EpicRO-CentralIngressPublic2
      Type: application

  ICFGALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties: 
      IpAddressType: ipv4
      Name: !Sub "${AWS::StackName}-ICFGALB"
      Scheme: internet-facing
      Subnets:
        - !ImportValue EpicRO-CentralIngressPublic1
        - !ImportValue EpicRO-CentralIngressPublic2      
      Type: application    

  #https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html
  HSWListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties: 
      Certificates: 
        - CertificateArn: !Ref HSWCertificateARN    
      DefaultActions: 
        - Type: forward
          TargetGroupArn: !Ref HSWTargetGroup
      LoadBalancerArn: !Ref HSWALB
      Port: 443
      Protocol: HTTPS

  ICFGListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties: 
      Certificates: 
        - CertificateArn: !Ref ICFGCertificateARN   
      DefaultActions: 
        - Type: forward
          TargetGroupArn: !Ref ICFGTargetGroup      
      LoadBalancerArn: !Ref ICFGALB        
      Port: 443
      Protocol: HTTPS
       

Outputs:
  HSWALB:
    Description: Hyperspace Web Application Load Balancer
    Export: 
      Name: EpicRO-HSWALB
    Value: !Ref HSWALB

  ICFGALB:
    Description: Interconnect Application Load Balancer
    Export: 
      Name: EpicRO-ICFGALB
    Value: !Ref ICFGALB    